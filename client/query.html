<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mongo Query Tool</title>
    <script src="/lib/jquery/dist/jquery.js"></script>
    <script src="/lib/underscore/underscore.js"></script>
    <style>
        table {
            border-collapse: collapse;
        }

        td {
            padding: 2px 5px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
<div id="unavailable">Service is unavailable</div>
<div id="root" style="display: none">
    <select id="collection"></select>
    <button id="showCollection" type="button">show</button>
    <form>
        <fieldset>
            <legend>Field</legend>
            <input name="field"/>
            <select name="operator">
                <option value="equals">Equals</option>
                <option value="contains">Contains</option>
            </select>
            <input name="value"/>
        </fieldset>
    </form>
    <table>
        <thead>
        <tr>
            <th class="action">Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<script>
    var skip = 0;
    var limit = 10;

    var fields_exclude = ['_id', 'hash', '__v'];

    var thead = $('thead > tr');
    function $thead(doc) {
        for (var key in doc) {
            var head = document.querySelector(`th[data-head=${key}]`);
            if (!head && fields_exclude.indexOf(key) < 0) {
                $('<th>')
                        .attr('data-head', key)
                        .html(key)
                        .appendTo(thead);
            }
        }
    }

    function $tr(object) {
        var tr = $('<tr></tr>').attr('id', object._id);
        for (var key in object) {
            if (fields_exclude.indexOf(key) < 0) {
                var value = object[key];
                var td = $('<td></td>')
                        .appendTo(tr);
                if (key in filters) {
                    var filter = filters[key];
                    if (filter instanceof Array) {
                        filter.forEach(function (filter) {
                            filter(value, td);
                        });
                    }
                    else {
                        filter(value, td);
                    }
                }
                else {
                    td.text(value);
                }
            }
        }

        $('<td>X</td>')
                .click(function () {
                    var params = $.param({
                        c: collection.value,
                        id: object._id
                    });
                    $.ajax({
                        url: '/api/admin?' + params,
                        type: 'DELETE',
                        success: function () {
                            query();
                        }
                    });
                })
                .appendTo(tr);

        return tr;
    }

    var field = $('[name=field]');

    var collection = document.getElementById('collection');

    function query(q) {
        if (!q) {
            q = location.hash.length > 0 ? decodeURIComponent(location.hash.slice(1)) : null;
            if ('string' == typeof q && !q.trim()) {
                q = null;
            }
        }
        if ('string' == typeof q) {
            q = q.replace('#', '').trim();
        }
        if (q) {
            location.hash = encodeURIComponent(JSON.stringify(q));
        }
        var params = {
            c: collection.value,
            skip: skip,
            limit: limit
        };
        if (q) {
            params.q = btoa(JSON.stringify(q));
        }

        var tbody = document.querySelector('tbody');
        $.getJSON('/api/admin/query?' + $.param(params), function (array) {
            thead.empty();
            tbody.innerHTML = '';
            location.hash = $.param(q);
            array.forEach(function (doc) {
                $thead(doc);
                var tr = $tr(doc)[0];
                if (tr instanceof HTMLElement) {
                    tbody.appendChild(tr);
                }
                else {
                    console.error(doc);
                }
            });
        })
    }

    $('[name=value] [name=operator]').change(function () {
        switch ($('[name=operator]').val()) {
            case 'equals':
                q = {};
                q[field.val()] = $('[name=value]').val();
                break;
            case 'contains':
                q = {};
                q[field.val()] = {$regex: '.*' + this.value + '.*'};
                break;
        }
        query(q);
    });

    document.getElementById('showCollection').addEventListener('click', function () {
        query({});
    });

    function filter_id(value, td) {
        td.attr('title', value);
        td.html(value.slice(-6));
    }

    var users = {};

    function load_user(value, td) {
        function found(user) {
            td.empty();
            $('<a></a>')
                    .attr('href', '/view/' + user.domain)
                    .attr('target', '_blank')
                    .text(user.domain)
                    .appendTo(td)
        }

        if (users[value]) {
            found(users[value]);
        }
        else {
            $.getJSON('/api/admin/entity?c=users&s=domain&id=' + value, found);
        }
    }

    function time(value, td) {
        value = new Date(value).toLocaleString();
        td
                .css('width', '160px')
                .text(value);
    }

    var filters = {
        _id: filter_id,
        source: [filter_id, load_user],
        target: [filter_id, load_user],
        user: [filter_id, load_user],
        start: time,
        time: time,
        auth: filter_id
    };

    $.getJSON('/api/admin/collections', function (data) {
        data.forEach(function (name) {
            $('<option/>')
                    .html(name)
                    .appendTo(collection);
        });
        $('#unavailable').hide();
        $('#root').show();
    });
</script>
</body>
</html>
