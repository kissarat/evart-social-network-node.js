<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dialog</title>
</head>
<body>
<div id="dialog"></div>
<template>
    <div class="user-info">
        <div class="_id"></div>
        <div class="name"></div>
    </div>
    <div class="text"></div>
    <div class="time"></div>
</template>
<div>
    <script src="/lib/underscore/underscore.js"></script>
    <script src="/lib/jquery/dist/jquery.js"></script>
    <script src="/lib/jquery-ui/jquery-ui.js"></script>
    <script src="/lib/backbone/backbone.js"></script>
    <script src="/lib/backbone.paginator/lib/backbone.paginator.js"></script>
    <script src="/js/ajax.js"></script>
    <script src="/js/domic.js"></script>
    <script src="/js/ui.js"></script>
</div>
<script>
    var api = new Ajax({base: '/api/'});

    var Collection = Backbone.PageableCollection.extend({
        mode: 'infinite',
        url: function () {
            return '/api/message?type=dialog&select=text&id=' + this.id;
        },

        state: {
            limit: 10,
            currentPage: 1,
            totalRecords: 2000,
            sortKey: '_id',
            order: 1
        },

        queryParams: {
            pageSize: 'limit',
            sortKey: 'sort',
            skip: function () {
                return (this.state.currentPage - 1) * this.state.pageSize;
            },
            currentPage: null,
            totalPages: null,
            totalRecords: null
        },

        parseRecords: function (records) {
            records.forEach(function (record) {
                record.index = parseInt(record._id.slice(2), 16);
            });
            return records;
        },

        getPage: function (number, options) {
            var self = this;
            this.__proto__.__proto__.getPage.call(this, number, options).success(function (_1, _2, _3) {
                setTimeout(function () {
                    self.trigger('finish', _1, _2, _3);
                }, 0);
            })
        }
    });

    var collection;

    api.GET('user', location.hash.slice(1)).then(function (user) {
        collection = new Collection();
        collection.id = user._id;
        collection.fullCollection.comparator = 'index';
        collection.on('finish', function () {
            dialog.innerHTML = '';
            collection.fullCollection.sort();
            collection.fullCollection.models.forEach(function (model) {
                var message = $import('template');
                message.$('.time').innerHTML = model.get('time');
                dialog.appendChild(message);
            });
        });
        collection.getFirstPage();
    });
</script>
</body>
</html>
